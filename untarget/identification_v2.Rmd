---
title: "Identification (v2)"
author: "Mar Garcia-Aloy"
output: 
  BiocStyle::html_document:
    toc: true
    number_sections: false
    toc_float: true
knit: (
  function(inputFile, encoding) { 

    pSubTitle <- "identification_v2_maturation_NEG"

    rmarkdown::render( 
      input       = inputFile, 
      encoding    = encoding, 
      params      = list(sub_title = pSubTitle),      
      output_file = pSubTitle) })
---

```{r startpoint, include = FALSE}
startpoint <- Sys.time()
```

# Preliminaries

## Parameters

```{r parameters}
polarity <- "NEG" # specify "POS" or "NEG"
study <- "maturation" # specify "maturation" or "tissues"
```

## Libraries

```{r, message=FALSE}
library(Rdisop)
library(CompoundDb)
library(OrgMassSpecR)
library(xcms)
library(MsCoreUtils)
```


# Study database

```{r database}
cmps <- read.csv("compounds.csv")
cmps <- cmps[cmps$formula != "", ]
cmps <- cmps[cmps$RT > 0, ]
if(study == "tissues"){
  cmps$RT <- cmps$RT + 4
}

ions <- data.frame(matrix(nrow = 0, ncol = 4))
for(i in 1:nrow(cmps)){
  if(polarity == "NEG"){
    if(grepl("D", cmps$formula[i])){
      ions <- rbind(
        ions, 
        cbind(rep(cmps$C[i], 6), rep(cmps$RT[i], 6), 
              unlist(mass2mz(getMolecule(cmps$formula[i])$exactmass, 
                             adduct = c("[M-H]-", "[M-H+HCOOH]-", "[2M-H]-"))), 
              c("[M-H]-", "[M-H+HCOOH]-", "[2M-H]-")))
    } else {
      ions <- rbind(
        ions, 
        cbind(rep(cmps$C[i], 6), rep(cmps$RT[i], 6), 
              unlist(mass2mz(MonoisotopicMass(
                cmps$formula[i], formula = ListFormula(cmps$formula[i])), 
                adduct = c("[M-H]-", "[M-H+HCOOH]-", "[2M-H]-"))), 
              c("[M-H]-", "[M-H+HCOOH]-", "[2M-H]-")))
    }
  } else if(polarity == "POS"){
    if(grepl("D", cmps$formula[i])){
      ions <- rbind(
        ions, 
        cbind(rep(cmps$C[i], 6), rep(cmps$RT[i], 6), 
              unlist(mass2mz(getMolecule(cmps$formula[i])$exactmass, 
                             adduct = c("[M+H]+", "[M+NH4]+", "[M+Na]+", "[M+K]+", "[2M+H]+", "[2M+Na]+"))), 
              c("[M+H]+", "[M+NH4]+", "[M+Na]+", "[M+K]+", "[2M+H]+", "[2M+Na]+")))
    } else {
      ions <- rbind(
        ions, 
        cbind(rep(cmps$C[i], 6), rep(cmps$RT[i], 6), 
              unlist(mass2mz(MonoisotopicMass(
                cmps$formula[i], formula = ListFormula(cmps$formula[i])), 
                adduct = c("[M+H]+", "[M+NH4]+", "[M+Na]+", "[M+K]+", "[2M+H]+", "[2M+Na]+"))), 
              c("[M+H]+", "[M+NH4]+", "[M+Na]+", "[M+K]+", "[2M+H]+", "[2M+Na]+")))
    }
  }
}
colnames(ions) <- c("C", "RT", "mz", "annotation")
ions$RT <- as.numeric(ions$RT)
ions$mz <- as.numeric(ions$mz)

rm(i)
```


# Main code

```{r main}
load(paste0(study, "/data/RData/data_XCMS_", polarity, ".RData"))
data <- featureValues(xdata, method = "sum", value = "into")
features <- data.frame(featureDefinitions(xdata))
#features$mean <- rowMeans(data, na.rm = T)

features$C <- NA
features$compound <- NA
features$annotation <- NA
features$ppm <- NA

thr.rt <- 3
if(study == "maturation" & polarity == "POS"){
  thr.ppm <- 10
} else {
  thr.ppm <- 3
}

for(i in 1:nrow(features)){
  cmp.i <- ions[unlist(matchWithPpm(features$mzmed[i], ions$mz, ppm = thr.ppm)),]
  cmp.i <- cmp.i[abs(features$rtmed[i] - cmp.i$RT) < thr.rt, ]
  if(nrow(cmp.i) > 0){
    features$C[i] <- paste(cmp.i$C, collapse = "; ")
    features$compound[i] <- paste(cmps$name[cmps$C %in% cmp.i], collapse = "; ")
    features$annotation[i] <- paste(cmp.i$annotation, collapse = "; ")
    features$ppm[i] <- paste(sprintf("%.1f", round(
      ((features$mzmed[i] - cmp.i$mz)/cmp.i$mz)*1e6, 1)), collapse = "; ")
    
    # isotopes
    fts <- features[features$rtmed > (features$rtmed[i] - thr.rt) & 
                      features$rtmed < (features$rtmed[i] + thr.rt), ]
    
    ## 13C
    idx <- unlist(matchWithPpm(features$mzmed[i] + 1.003355, 
                               fts$mzmed, ppm = thr.ppm))
    if(length(idx) > 0){
      idx <- which(rownames(features) == rownames(fts)[idx])
      xdata <- readMSData(
        files = paste0(study, "/data/", polarity, "_FS_fixed/", 
                       names(which.max(data[i,]))),
        mode = "onDisk")
      chr <- chromatogram(xdata, mz = features$mzmed[i] + 0.01 * c(-1, 1))
      chr <- chromPeaks(findChromPeaks(
        chr, param = CentWaveParam(peakwidth = c(2, 20))))
      if(length(chr[chr[,"rt"] > (min(cmp.i$RT) - thr.rt) & 
                    chr[,"rt"] < (max(cmp.i$RT) + thr.rt),]) > 0){
        chr <- chr[chr[,"rt"] > (min(cmp.i$RT) - thr.rt) & 
                     chr[,"rt"] < (max(cmp.i$RT) + thr.rt),]
      } else {
        chr <- chr[which.min(abs(chr[,"rt"] - cmp.i$RT)), ]
      }
      
      sps <- as.data.frame(xdata[[closest(chr[1], rtime(xdata))]])
      if(sps[unlist(matchWithPpm(features$mzmed[i], sps, ppm = thr.ppm)), "i"] > 
         sps[unlist(matchWithPpm(features$mzmed[i] + 1.003355, sps, ppm = thr.ppm)), 
             "i"]){
        features$C[idx] <- paste(cmp.i$C, collapse = "; ")
        features$compound[idx] <- paste(cmps$name[cmps$C %in% cmp.i], collapse = "; ")
        features$annotation[idx] <- paste(paste0("13C", cmp.i$annotation, 
                                                 collapse = "; "))
        features$ppm[idx] <- paste(sprintf("%.1f", round(
          ((features$mzmed[idx] - (cmp.i$mz + 1.003355)) / (
            cmp.i$mz + 1.003355))*1e6, 1)), collapse = "; ")
      }
      
      ## 2(13C)
      idx <- unlist(matchWithPpm(features$mzmed[i] + 1.003355*2, 
                                 fts$mzmed, ppm = thr.ppm))
      if(length(idx) > 0){
        idx <- which(rownames(features) == rownames(fts)[idx])
        if(sps[unlist(matchWithPpm(features$mzmed[i] + 1.003355, sps, 
                                   ppm = thr.ppm)), "i"] > 
           sps[unlist(matchWithPpm(features$mzmed[i] + 1.003355*2, sps, 
                                   ppm = thr.ppm)), 
               "i"]){
          features$C[idx] <- paste(cmp.i$C, collapse = "; ")
          features$compound[idx] <- paste(cmps$name[cmps$C %in% cmp.i], collapse = "; ")
          features$annotation[idx] <- paste(paste0("2(13C)", cmp.i$annotation, 
                                                   collapse = "; "))
          features$ppm[idx] <- paste(sprintf("%.1f", round(
            ((features$mzmed[idx] - (cmp.i$mz + 1.003355*2)) / (
              cmp.i$mz + 1.003355*2))*1e6, 1)), collapse = "; ")
        }
        
        ## 3(13C)
        idx <- unlist(matchWithPpm(features$mzmed[i] + 1.003355*3, 
                                   fts$mzmed, ppm = thr.ppm))
        if(length(idx) > 0){
          idx <- which(rownames(features) == rownames(fts)[idx])
          if(length(unlist(matchWithPpm(features$mzmed[i] + 1.003355*3, sps, 
                                        ppm = thr.ppm))) > 0){
            if(sps[unlist(matchWithPpm(features$mzmed[i] + 1.003355*2, sps, 
                                       ppm = thr.ppm)), "i"] > 
               sps[unlist(matchWithPpm(features$mzmed[i] + 1.003355*3, sps, 
                                       ppm = thr.ppm)), 
                   "i"]){
              features$C[idx] <- paste(cmp.i$C, collapse = "; ")
              features$compound[idx] <- paste(cmps$name[cmps$C %in% cmp.i], collapse = "; ")
              features$annotation[idx] <- paste(
                paste0("3(13C)", cmp.i$annotation, collapse = "; "))
              features$ppm[idx] <- paste(sprintf("%.1f", round(
                ((features$mzmed[idx] - (cmp.i$mz + 1.003355*3)) / (
                  cmp.i$mz + 1.003355*3))*1e6, 1)), collapse = "; ")
            }
            
            ## 4(13C)
            idx <- unlist(matchWithPpm(features$mzmed[i] + 1.003355*4, 
                                       fts$mzmed, ppm = thr.ppm))
            if(length(idx) > 0){
              idx <- which(rownames(features) == rownames(fts)[idx])
              if(sps[unlist(matchWithPpm(features$mzmed[i] + 1.003355*3, sps, 
                                       ppm = thr.ppm)), "i"] > 
               sps[unlist(matchWithPpm(features$mzmed[i] + 1.003355*4, sps, 
                                       ppm = thr.ppm)), 
                   "i"]){
              features$C[idx] <- paste(cmp.i$C, collapse = "; ")
              features$compound[idx] <- paste(cmps$name[cmps$C %in% cmp.i], collapse = "; ")
              features$annotation[idx] <- paste(
                paste0("4(13C)", cmp.i$annotation, collapse = "; "))
              features$ppm[idx] <- paste(sprintf("%.1f", round(
                ((features$mzmed[idx] - (cmp.i$mz + 1.003355*4)) / (
                  cmp.i$mz + 1.003355*4))*1e6, 1)), collapse = "; ")
              }
              
              ## 5(13C)
              idx <- unlist(matchWithPpm(features$mzmed[i] + 1.003355*5, 
                                       fts$mzmed, ppm = thr.ppm))
              if(length(idx) > 0){
                print(i)
              } # close 5(13C)
            } # close 4(13C)
          }
        } # close 3(13C)
      } # close 2(13C)
    } # close 13C
  }
}
rm(i, cmp.i, fts, sps, xdata, chr, idx, cmps)

table(is.na(features$C))
```


# Session information

```{r session}
Sys.time()-startpoint
devtools::session_info()
```

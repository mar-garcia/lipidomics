---
title: "Identification"
author: "Mar Garcia-Aloy"
output: 
  BiocStyle::html_document:
    toc: true
    number_sections: false
    toc_float: true
knit: (
  function(inputFile, encoding) { 

    pSubTitle <- "identification_maturation_NEG"

    rmarkdown::render( 
      input       = inputFile, 
      encoding    = encoding, 
      params      = list(sub_title = pSubTitle),      
      output_file = pSubTitle) })
---

```{r startpoint, include = FALSE}
startpoint <- Sys.time()
```

# Preliminaries

## Parameters

```{r parameters}
polarity <- "NEG" # specify "POS" or "NEG"
study <- "maturation" # specify "maturation" or "tissues"
cmps_isotopes <- list(
  C37H69O8P  = c("C0034", "C0261", "C0354"),
  C39H67O8P  = c("C0217", "C0312"),
  C39H68O5   = c("C5223", "C5319", "C5544"),
  C39H69O8P  = c("C0035", "C0036"),
  C39H72O5   = c("C0094", "C5121"),
  C39H72NO8P = c("C0028", "C1516", "C1608", "C1697"),
  C39H74NO8P = c("C0027", "C1515"),
  #C40H76NO8P = c("C0770", "C0837", "C0869"),
  #C41H64O10  = c("C4266", "C4345"),
  C41H74NO8P = c("C0031", "C0032", "C1616"),
  C42H76NO8P = c("C0892", "C0972", "C0986", "C1075"),
  #C42H78NO8P = c("C0971", "C1074"),
  C43H80NO8P = c("C1537", "C1629"),
  C44H80NO8P = c("C0023", "C0025", "C0845"),
  C45H74O10  = c("C0082", "C3932", "C4197"),
  C45H76O10  = c("C0081", "C3931", "C4196"),
  C45H78O10  = c("C3930", "C3975", "C4070"),
  C45H80O10  = c("C3873", "C3974"),
  C48H92NO8P = c("C0749", "C1012"),
  C51H84O15  = c("C0077", "C4821"),
  C51H86O15  = c("C0076", "C4732", "C4820"),
  C45H88NO8P = c("C1446", "C1542"),
  C51H88O15  = c("C4599", "C4694", "C4731"))
```

## Libraries

```{r libraries, message = FALSE}
library(xcms)
library(plotly)
library(Rdisop)
library(OrgMassSpecR)
library(CompoundDb)
```

# Data import

```{r import}
cmps <- read.csv("compounds.csv")
cmps$mz <- NA
if(polarity == "POS"){
  cmps$NH4 <- NA
  cmps$Na <- NA
  for(i in 1:nrow(cmps)
  ){
    if(cmps$formula[i] != ""){
      if(grepl("D", cmps$formula[i])){
        cmps$mz[i] <- unlist(mass2mz(getMolecule(
          cmps$formula[i])$exactmass, "[M+H]+"))
        cmps$NH4[i] <- unlist(mass2mz(getMolecule(
          cmps$formula[i])$exactmass, "[M+NH4]+"))
        cmps$Na[i] <- unlist(mass2mz(getMolecule(
          cmps$formula[i])$exactmass, "[M+Na]+"))
      } else {
        cmps$mz[i] <- unlist(mass2mz(MonoisotopicMass(
          formula = ListFormula(cmps$formula[i])), "[M+H]+"))
        cmps$NH4[i] <- unlist(mass2mz(MonoisotopicMass(
          formula = ListFormula(cmps$formula[i])), "[M+NH4]+"))
        cmps$Na[i] <- unlist(mass2mz(MonoisotopicMass(
          formula = ListFormula(cmps$formula[i])), "[M+Na]+"))
      }
    }
  }} else if(polarity == "NEG"){
    cmps$Cl <- NA
    cmps$FA <- NA
    for(i in 1:nrow(cmps)){
      if(cmps$formula[i] != ""){
        if(grepl("D", cmps$formula[i])){
          cmps$mz[i] <- unlist(mass2mz(getMolecule(
            cmps$formula[i])$exactmass, "[M-H]-"))
          cmps$Cl[i] <- unlist(mass2mz(getMolecule(
            cmps$formula[i])$exactmass, "[M+Cl]-"))
          cmps$FA[i] <- unlist(mass2mz(getMolecule(
            cmps$formula[i])$exactmass, "[M-H+HCOOH]-"))
        } else {
          cmps$mz[i] <- unlist(mass2mz(MonoisotopicMass(
            formula = ListFormula(cmps$formula[i])), "[M-H]-"))
          cmps$Cl[i] <- unlist(mass2mz(MonoisotopicMass(
            formula = ListFormula(cmps$formula[i])), "[M+Cl]-"))
          cmps$FA[i] <- unlist(mass2mz(MonoisotopicMass(
            formula = ListFormula(cmps$formula[i])), "[M-H+HCOOH]-"))
        }
      }}
  }
DT::datatable(cmps[,-2])

load(paste0(study, "/data/RData/data_XCMS_", polarity, ".RData"))
features <- data.frame(featureDefinitions(xdata))
```

# Study database

## Build database

### Pseudo-molecular ions

```{r database}
cmps <- read.csv("compounds.csv")
if(study == "tissues"){
  cmps$RT <- cmps$RT + 4
}

# Calculate the mz values of the molecular ion
if(polarity == "POS"){
  ion <- 1.007276
  smbl <- "+"
  pol <- 1
} else if(polarity == "NEG"){
  ion <- -1.007276
  smbl <- "-"
  pol  <- (-1)
}
cmps$mz <- NA
for(i in 1:nrow(cmps)){
  if(cmps$formula[i] != ""){
    if(grepl("D", cmps$formula[i])){
      cmps$mz[i] <- getMolecule(cmps$formula[i])$exactmass + ion
    }
    else {
      cmps$mz[i] <- MonoisotopicMass(
        formula = ListFormula(cmps$formula[i])) + ion
    }
  }
}
cmps$annotation <- paste0("[M", smbl, "H]", smbl)
rm(i)
```

### Other ions

```{r other-ions}
cmps_ions <- read.csv("compounds_ions.csv")
cmps_ions$ID <- gsub("\\*", smbl, cmps_ions$ID)

for(i in seq(length(cmps_isotopes))){
  for(j in 2:length(cmps_isotopes[[i]])){
    cmps_ions <- cbind(cmps_ions, cmps_ions[,cmps_isotopes[[i]][1]])
    colnames(cmps_ions)[ncol(cmps_ions)] <- cmps_isotopes[[i]][j]
  }
}

ions_long <- cmps[, c("C", "RT", "mz", "annotation")]

for(i in 2:ncol(cmps_ions)){      # compound "i"
  for(j in seq(nrow(cmps_ions))){ # ion "j"
    if((cmps_ions[j, i] == 2) | (cmps_ions[j, i] == pol)){
      ions_loop <- data.frame(matrix(ncol = ncol(ions_long), nrow = 1))
      colnames(ions_loop) <- colnames(ions_long)
      ions_loop$C <- colnames(cmps_ions)[i]
      idx <- which(cmps$C == colnames(cmps_ions)[i])
      ions_loop$RT <- cmps$RT[idx]
      if(grepl("13C", cmps_ions$ID[j])){
        if(grepl("\\(13C)", cmps_ions$ID[j])){
          ions_loop$mz <- unlist(mass2mz(getMolecule(
            cmps$formula[idx])$exactmass, 
            substring(gsub("\\(13C)", "", cmps_ions$ID[j]), 2))) + 1.003355 * 
            as.numeric(substring(gsub("\\(13C)", "", cmps_ions$ID[j]), 1, 1))
        } else {
          ions_loop$mz <- unlist(mass2mz(getMolecule(
            cmps$formula[idx])$exactmass, 
            gsub("13C", "", cmps_ions$ID[j]))) + 1.003355
        }
      } else if(cmps_ions$ID[j] == "[M]"){
        ions_loop$mz <- getMolecule(cmps$formula[idx])$exactmass
      }else {
        ions_loop$mz <- unlist(mass2mz(getMolecule(
          cmps$formula[idx])$exactmass, cmps_ions$ID[j]))
      }
      ions_loop$annotation <- cmps_ions$ID[j] 
      ions_long <- rbind(ions_long, ions_loop)
    }
  }
}
rm(i, j, ions_loop, idx, pol, smbl)

cmps_ft <- read.csv("compounds_ft.csv")
cmps_ft <- cmps_ft[cmps_ft$polarity == polarity, ]

for(i in seq(length(cmps_isotopes))){
  for(j in 2:length(cmps_isotopes[[i]])){
    cmps_ft_tmp <- cmps_ft[cmps_ft$C == cmps_isotopes[[i]][1],]
    if(nrow(cmps_ft_tmp) > 0){
      cmps_ft_tmp$C <- cmps_isotopes[[i]][j]
      cmps_ft <- rbind(cmps_ft, cmps_ft_tmp)
    }
  }
}
cmps_ft$RT <- NA
for(i in seq(nrow(cmps_ft))){
  cmps_ft$RT[i] <- cmps$RT[cmps$C == cmps_ft$C[i]]
}
cmps_ft <- subset(cmps_ft, select = c("C", "RT", "mz", "annotation"))
for(i in seq(nrow(cmps_ft))){
  if(grepl("C", cmps_ft$mz[i])){
    cmps_ft$mz[i] <- getMolecule(cmps_ft$mz[i])$exactmass + ion
  }
}
cmps_ft$mz <- as.numeric(cmps_ft$mz)
ions_long <- rbind(ions_long, cmps_ft)
rm(i, cmps_ft)
```


## Background ions

```{r, eval=FALSE}
mzvals <- 655.1581 + (getMolecule("SiC2H6O")$exactmass)*seq(15)
rtimes <- c(14.42, 15.37, 16.16, 16.85, 17.44, 17.96, 18.42, 18.83, 19.17, 
            19.51, 19.79, 20.03, 20.27, 20.48, 1221)
annots <- c()
for(i in 2:(length(mzvals)-1)){
  annots <- c(annots, paste0("[M-H+", i, "(O-Si(CH3)2)]-"))
}
annots <- c("[M-H]-", "[M-H+O-Si(CH3)2]-", annots)

back <- data.frame(matrix(nrow = length(mzvals), ncol = ncol(ions_long)))
colnames(back) <- colnames(ions_long)
back$C <- "C9999"
back$RT <- rtimes
back$mz <- mzvals
back$annotation <- annots
ions_long <- rbind(ions_long, back)
back$mz <- back$mz + 1.0005
back$annotation <- paste(back$annotation, "+ 1.0005")

rm(mzvals, rtimes, annots, back)
```

## Matching

```{r matching, warning=FALSE, message=FALSE}
features$C <- NA
features$compound <- NA
features$annotation <- NA
features$ppm <- NA
for(i in 1:nrow(features)){
  rtr <- c(features$rtmed[i], features$rtmed[i]) + 10 * c(-1, 1)
  if(polarity == "POS"){
    cmp.i <- ions_long[unlist(
      matchWithPpm(features$mzmed[i], ions_long$mz, ppm = 15)), ]
  } else if(polarity == "NEG"){
    cmp.i <- ions_long[unlist(
      matchWithPpm(features$mzmed[i], ions_long$mz, ppm = 10)), ]
  }
  if(nrow(cmp.i) > 0){
    if(cmp.i$C %in% "C0015"){
      rtr[1] <- rtr[1] - 30
    }}
  cmp.i <- cmp.i[cmp.i$RT > rtr[1] & cmp.i$RT < rtr[2], ]
  features$C[i] <- paste(cmp.i$C, collapse = "; ")
  features$compound[i] <- paste(cmps$name[cmps$C %in% cmp.i$C], collapse = "; ")
  features$annotation[i] <- paste(unique(cmp.i$annotation), collapse = "; ")
  features$ppm[i] <- paste(unique(sprintf("%.1f", round(abs((
    (features$mzmed[i] - cmp.i$mz)/cmp.i$mz)*1e6), 1))), collapse = "; ")
  rm(rtr, cmp.i)
}
rm(i)

features$mzmed <- sprintf("%.4f", round(features$mzmed, 4))
features$rtmed <- round(features$rtmed)
#features$ppm <- sprintf("%.1f", round(abs(features$ppm), 1))
#features <- features[order(features$rtmed), ]
```

# Identifications

```{r identifications}
DT::datatable(
  features[,c("mzmed", "rtmed", "C", "compound", "annotation", "ppm")], 
  filter = "top")
```

# PCA

```{r pca, message=FALSE, warning=FALSE, eval=TRUE}
data <- featureValues(xdata, method = "sum", value = "into")
set.seed(123)
data <- t(imputeRowMinRand(data, method = "from_to",
                           min_fraction = 1/100,
                           min_fraction_from = 1/1000
))
dt <- log10(data)
scaling.pareto <- BioMark::scalefun(sc.p="pareto")
dt <- data.frame(scaling.pareto(dt))
pca <- prcomp(dt, center = FALSE, scale. = FALSE)
tmp <- data.frame(pca$x)
if(study == "maturation"){
  plot_ly(x = tmp$PC1, y = tmp$PC2,
          text = gsub(".mzData", "", rownames(tmp)),
          color = xdata$type, colors = "Set1")
} else if(study == "tissues"){
  plot_ly(x = tmp$PC1, y = tmp$PC2,
          text = gsub(".mzData", "", rownames(tmp)),
          color = xdata$tissue, colors = "Set1")
}


features$class <- "unknowns"
for(i in seq(nrow(features))){
  if(length(cmps$class[cmps$name == 
                       unlist(strsplit(features$compound[i], "; "))[1]]) > 0){
    features$class[i] <- cmps$class[
      cmps$name == unlist(strsplit(features$compound[i], "; "))[1]]
  }
}
tmp <- data.frame(pca$rotation)
plot_ly(x = tmp$PC1, y = tmp$PC2,
        text = paste(features$C, features$compound, features$annotation, 
                     "mz:", round(as.numeric(features$mzmed), 4), 
                     "RT:", round(features$rtmed)), 
        color = features$compound != "", colors = "Set2")
table(features$compound != "")
if(study == "maturation"){
  tmpx <- merge(tmp[, c("PC1", "PC2")], features[,c("compound", "class")], 
                by = "row.names")
  if(polarity == "NEG"){
    tmpx <- tmpx[(tmpx$PC1 >= min(tmp$PC1[features$compound != ""])) &
                   (tmpx$PC2 >= min(tmp$PC2[features$compound != ""])),]
  } else if(polarity == "POS"){
    tmpx <- tmpx[(tmpx$PC1 >= min(tmp$PC1[features$compound != ""])) &
                   (tmpx$PC2 <= max(tmp$PC2[features$compound != ""])),]
  }
  table(tmpx$compound != "")
  paste0("identified ", round((sum(tmpx$compound != "")/nrow(tmpx))*100, 2), 
         "% of sample-features")
}

features$class[is.na(features$class)] <- "unknowns"
plot_ly(x = tmp$PC1, y = tmp$PC2,
        text = paste(features$C, features$compound, features$annotation, 
                     "mz:", round(as.numeric(features$mzmed), 4), 
                     "RT:", round(features$rtmed)), 
        color = features$class, colors = "Set1")
table(features$class)
```

## Study samples

```{r, warning=FALSE}
if(study == "maturation"){
  data <- data[xdata$type == "study",]
}else if(study == "tissues"){
  data <- data[xdata$pt == "pt11",]
}
dt <- log10(data)
dt <- data.frame(scaling.pareto(dt))
pca <- prcomp(dt, center = FALSE, scale. = FALSE)
tmp <- data.frame(pca$x)
if(study == "maturation"){
  plot_ly(x = tmp$PC1, y = tmp$PC2,
        text = gsub(".mzData", "", rownames(tmp)),
        color = xdata$time[xdata$type == "study"], colors = "BrBG")
}else if(study == "tissues"){
  plot_ly(x = tmp$PC1, y = tmp$PC2,
        text = gsub(".mzData", "", rownames(tmp)),
        color = xdata$tissue[xdata$pt == "pt11"], colors = "Set1")
}


tmp <- data.frame(pca$rotation)

plot_ly(x = tmp$PC1, y = tmp$PC2,
        text = paste(features$C, features$compound, features$annotation, 
                     "mz:", round(as.numeric(features$mzmed), 4), 
                     "RT:", round(features$rtmed)), 
        color = features$compound != "", colors = "Set2")

features$class[is.na(features$class)] <- "unknowns"
plot_ly(x = tmp$PC1, y = tmp$PC2,
        text = paste(features$C, features$compound, features$annotation, 
                     "mz:", round(as.numeric(features$mzmed), 4), 
                     "RT:", round(features$rtmed)), 
        color = features$class, colors = "Set1")
```


# Session information

```{r session}
Sys.time()-startpoint
devtools::session_info()
```
